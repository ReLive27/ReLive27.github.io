<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Spring Security OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存 - ReLive27的博客</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="">





    <meta property="og:type" content="article">
<meta property="og:title" content="Spring Security OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存">
<meta property="og:url" content="https://relive27.github.io/2022/09/12/jwk-cache-and-rotate-key/index.html">
<meta property="og:site_name" content="ReLive27的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-12T01:56:37.000Z">
<meta property="article:modified_time" content="2022-09-15T14:32:21.628Z">
<meta property="article:author" content="ReLive27">
<meta property="article:tag" content="spring security">
<meta name="twitter:card" content="summary">





<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="ReLive27的博客" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="/images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">从这里开始</a>
            
            <a class="navbar-item "
               href="/archives">完整档案</a>
            
            <a class="navbar-item "
               href="/tags">标签</a>
            
            <a class="navbar-item "
               href="/categories">分类</a>
            
            <a class="navbar-item "
               href="/categories/weekly/">Weekly</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜索" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ReLive27">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Spring Security OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2022-09-12T01:56:37.000Z" itemprop="datePublished">9月 12 2022</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/SpringSecurity/">SpringSecurity</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            36 分钟 读完 (约 5326 字)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <!-- jwk-cache --><html><head></head><body><span id="more"></span>

<h2 id="Spring-Security-OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存"><a href="#Spring-Security-OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存" class="headerlink" title="Spring Security OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存"></a>Spring Security OAuth2实现简单的密钥轮换及配置资源服务器JWK缓存</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>在OAuth2协议中授权服务器或者OIDC中身份提供服务常使用私钥对JWT令牌进行签名，第三方服务客户端或者资源服务使用已知URL上发布的公钥对令牌进行验证。</p>
<p>这些密钥构成了各方之间安全的基础。为了维护安全性，保持私钥免受任何网络攻击是所必需的。</p>
<p>已确定的用于保护密钥不被泄露的最佳做法之一称为<em>密钥滚动更新</em>或<em>密钥轮换</em>。在此方法中，我们丢弃当前密钥并生成一对新密钥，用于对令牌进行签名和验证。</p>
<h4 id="为什么我们需要密钥轮换？"><a href="#为什么我们需要密钥轮换？" class="headerlink" title="为什么我们需要密钥轮换？"></a>为什么我们需要密钥轮换？</h4><p>为了确保公钥和私钥对的安全性免受黑客的攻击，建议在一段时间后轮换密钥。必须丢弃以前的密钥，并且必须将新生成的密钥用于进一步的加密操作。根据NIST指南，密钥必须至少<strong>每两年轮换一次</strong>。</p>
<h4 id="如何实现密钥轮换？"><a href="#如何实现密钥轮换？" class="headerlink" title="如何实现密钥轮换？"></a>如何实现密钥轮换？</h4><p>所有公钥都由授权服务或身份提供服务在 Web 上发布的URL提供，URL返回一个对象，称为 JSON Web Keys或 JWKS，其中包含多个<a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc7517">JSON Web Key</a> (是一种 JSON 数据结构，表示一组公钥)，通常称为 <strong>JWK</strong>。在验证由私钥签名的 JWT时，将使用与私钥相对应的JWK。以下是JWKS 示例，其<strong>keys</strong>包含一个 JWK 数组。</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">"keys": [</span><br><span class="line">  {</span><br><span class="line">    "alg": "RS256",</span><br><span class="line">    "kty": "RSA",</span><br><span class="line">    "use": "sig",</span><br><span class="line">    "x5c": [</span><br><span class="line">      "MIIC+DCCAeCgAwIBAgIJBIGjYW6hFpn2MA0GCSqGSIb3DQEBBQUAMCMxITAfBgNVBAMTGGN1c3RvbWVyLWRlbW9zLmF1dGgwLmNvbTAeFw0xNjExMjIyMjIyMDVaFw0zMDA4MDEyMjIyMDVaMCMxITAfBgNVBAMTGGN1c3RvbWVyLWRlbW9zLmF1dGgwLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMnjZc5bm/eGIHq09N9HKHahM7Y31P0ul+A2wwP4lSpIwFrWHzxw88/7Dwk9QMc+orGXX95R6av4GF+Es/nG3uK45ooMVMa/hYCh0Mtx3gnSuoTavQEkLzCvSwTqVwzZ+5noukWVqJuMKNwjL77GNcPLY7Xy2/skMCT5bR8UoWaufooQvYq6SyPcRAU4BtdquZRiBT4U5f+4pwNTxSvey7ki50yc1tG49Per/0zA4O6Tlpv8x7Red6m1bCNHt7+Z5nSl3RX/QYyAEUX1a28VcYmR41Osy+o2OUCXYdUAphDaHo4/8rbKTJhlu8jEcc1KoMXAKjgaVZtG/v5ltx6AXY0CAwEAAaMvMC0wDAYDVR0TBAUwAwEB/zAdBgNVHQ4EFgQUQxFG602h1cG+pnyvJoy9pGJJoCswDQYJKoZIhvcNAQEFBQADggEBAGvtCbzGNBUJPLICth3mLsX0Z4z8T8iu4tyoiuAshP/Ry/ZBnFnXmhD8vwgMZ2lTgUWwlrvlgN+fAtYKnwFO2G3BOCFw96Nm8So9sjTda9CCZ3dhoH57F/hVMBB0K6xhklAc0b5ZxUpCIN92v/w+xZoz1XQBHe8ZbRHaP1HpRM4M7DJk2G5cgUCyu3UBvYS41sHvzrxQ3z7vIePRA4WF4bEkfX12gvny0RsPkrbVMXX1Rj9t6V7QXrbPYBAO+43JvDGYawxYVvLhz+BJ45x50GFQmHszfY3BR9TPK8xmMmQwtIvLu1PMttNCs7niCYkSiUv2sc2mlq1i3IashGkkgmo="</span><br><span class="line">    ],</span><br><span class="line">    "n": "yeNlzlub94YgerT030codqEztjfU_S6X4DbDA_iVKkjAWtYfPHDzz_sPCT1Axz6isZdf3lHpq_gYX4Sz-cbe4rjmigxUxr-FgKHQy3HeCdK6hNq9ASQvMK9LBOpXDNn7mei6RZWom4wo3CMvvsY1w8tjtfLb-yQwJPltHxShZq5-ihC9irpLI9xEBTgG12q5lGIFPhTl_7inA1PFK97LuSLnTJzW0bj096v_TMDg7pOWm_zHtF53qbVsI0e3v5nmdKXdFf9BjIARRfVrbxVxiZHjU6zL6jY5QJdh1QCmENoejj_ytspMmGW7yMRxzUqgxcAqOBpVm0b-_mW3HoBdjQ",</span><br><span class="line">    "e": "AQAB",</span><br><span class="line">    "kid": "NjVBRjY5MDlCMUIwNzU4RTA2QzZFMDQ4QzQ2MDAyQjVDNjk1RTM2Qg",</span><br><span class="line">    "x5t": "NjVBRjY5MDlCMUIwNzU4RTA2QzZFMDQ4QzQ2MDAyQjVDNjk1RTM2Qg"</span><br><span class="line">  }</span><br><span class="line">]}</span><br></pre></td></tr></tbody></table></figure>



<p>典型的密钥轮换策略可避免客户端发送使用以前颁发的密钥签名的 JWT 的验证失败潜在问题，因此，在令牌完全过期之前，我们需要在一段时间内保持两个密钥（先前和当前）有效 - 刚好足以为客户端提供更新其本地缓存的空间。</p>
<p><strong>先决条件</strong>：</p>
<ul>
<li>java8+</li>
<li>Redis</li>
<li>JWT</li>
</ul>
<br>

<p>在阅读文章前，首先说明下文<strong>密钥</strong>与<strong>JWK</strong>表示相同含义。虽然JWK从规范定义层面表示一组公钥，但是在代码层面JWK所指定的是一组密钥。例如<code>RSAKey</code>,<code>ECKey</code>等等。</p>
<h3 id="授权服务器实现密钥轮换"><a href="#授权服务器实现密钥轮换" class="headerlink" title="授权服务器实现密钥轮换"></a>授权服务器实现密钥轮换</h3><p>本节中我们将使用<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-authorization-server">Spring Authorization Server</a> 搭建一个简单的授权服务器，并实现<code>JWKSource</code>自定义密钥轮换逻辑，密钥缓存策略提供本地内存，caffeine，redis三种实现方式。</p>
<h4 id="Maven依赖"><a href="#Maven依赖" class="headerlink" title="Maven依赖"></a>Maven依赖</h4><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-oauth2-authorization-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>首先我们从<code>application.yml</code>配置开始，这里我们指定授权服务器端口为8080，并添加redis连接配置信息：</p>
<figure class="highlight yaml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">server:</span></span><br><span class="line">  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">redis:</span></span><br><span class="line">    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span></span><br><span class="line">    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span></span><br><span class="line">    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span></span><br><span class="line">    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800</span></span><br><span class="line">    <span class="hljs-attr">lettuce:</span></span><br><span class="line">      <span class="hljs-attr">pool:</span></span><br><span class="line">        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span></span><br><span class="line">        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60</span></span><br><span class="line">        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span></span><br><span class="line">        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span></span><br><span class="line">      <span class="hljs-attr">shutdown-timeout:</span> <span class="hljs-number">100</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<br>

<p>接下来我们将创建<code>AuthorizationServerConfig</code>配置类，用于配置OAuth2及OIDC所需Bean，首先我们将新增OAuth2客户端信息: </p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-keyword">public</span> RegisteredClientRepository <span class="title function_">registeredClientRepository</span><span class="hljs-params">()</span> {</span><br><span class="line">    <span class="hljs-type">RegisteredClient</span> <span class="hljs-variable">registeredClient</span> <span class="hljs-operator">=</span> RegisteredClient.withId(UUID.randomUUID().toString())</span><br><span class="line">            .clientId(<span class="hljs-string">"relive-client"</span>)</span><br><span class="line">            .clientSecret(<span class="hljs-string">"{noop}relive-client"</span>)</span><br><span class="line">            .clientAuthenticationMethods(s -&gt; {</span><br><span class="line">                s.add(ClientAuthenticationMethod.CLIENT_SECRET_POST);</span><br><span class="line">                s.add(ClientAuthenticationMethod.CLIENT_SECRET_BASIC);</span><br><span class="line">            })</span><br><span class="line">            .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)</span><br><span class="line">            .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)</span><br><span class="line">            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)</span><br><span class="line">            .authorizationGrantType(AuthorizationGrantType.PASSWORD)</span><br><span class="line">            .redirectUri(<span class="hljs-string">"http://127.0.0.1:8070/login/oauth2/code/messaging-client-authorization-code"</span>)</span><br><span class="line">            .scope(<span class="hljs-string">"message.read"</span>)</span><br><span class="line">            .clientSettings(ClientSettings.builder()</span><br><span class="line">                    .requireAuthorizationConsent(<span class="hljs-literal">true</span>)</span><br><span class="line">                    .requireProofKey(<span class="hljs-literal">false</span>)</span><br><span class="line">                    .build())</span><br><span class="line">            .tokenSettings(TokenSettings.builder()</span><br><span class="line">                    .accessTokenFormat(OAuth2TokenFormat.SELF_CONTAINED) </span><br><span class="line">                    .idTokenSignatureAlgorithm(SignatureAlgorithm.RS256)</span><br><span class="line">                    .accessTokenTimeToLive(Duration.ofSeconds(<span class="hljs-number">30</span> * <span class="hljs-number">60</span>))</span><br><span class="line">                    .refreshTokenTimeToLive(Duration.ofSeconds(<span class="hljs-number">60</span> * <span class="hljs-number">60</span>))</span><br><span class="line">                    .reuseRefreshTokens(<span class="hljs-literal">true</span>)</span><br><span class="line">                    .build())</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">InMemoryRegisteredClientRepository</span>(registeredClient);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>和以往文章一样，指定OAuth2客户端信息，并将OAuth2客户端信息存储在内存中，如果你需要配置数据库存储，请参考文章<a href="https://relive27.github.io/2022/06/26/spring-security-oauth2-jwt/">将JWT与Spring Security OAuth2结合使用</a> 。</p>
<ul>
<li><strong>clientId</strong>: relive-client</li>
<li><strong>clientSecret</strong>: relive-client</li>
<li><strong>redirectUri</strong>: <a target="_blank" rel="noopener" href="http://127.0.0.1:8070/login/oauth2/code/messaging-client-authorization-code">http://127.0.0.1:8070/login/oauth2/code/messaging-client-authorization-code</a></li>
<li><strong>scope</strong>: message.read</li>
</ul>
<br>

<p>简化其他高级配置，使用OAuth2授权服务默认配置，并将未认证的授权请求重定向到登录页面：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="hljs-keyword">public</span> SecurityFilterChain <span class="title function_">authorizationServerSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {</span><br><span class="line">    OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);</span><br><span class="line">    <span class="hljs-keyword">return</span> http.exceptionHandling(exceptions -&gt; exceptions.</span><br><span class="line">                    authenticationEntryPoint(<span class="hljs-keyword">new</span> <span class="title class_">LoginUrlAuthenticationEntryPoint</span>(<span class="hljs-string">"/login"</span>))).build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<br>

<h5 id="自定义JWKSource实现密钥轮换"><a href="#自定义JWKSource实现密钥轮换" class="headerlink" title="自定义JWKSource实现密钥轮换"></a>自定义JWKSource实现密钥轮换</h5><p>之前文章中授权服务启动时随机生成一个2048字节的RSA密钥，用于令牌的签名密钥。本示例中我们将自定义<code>JWKSource</code>并实现密钥轮换策略：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="title class_">RotateJwkSource</span>&lt;C <span class="hljs-keyword">extends</span> <span class="title class_">SecurityContext</span>&gt; <span class="hljs-keyword">implements</span> <span class="title class_">JWKSource</span>&lt;C&gt; {</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JWKSource&lt;C&gt; failoverJWKSource;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JWKSetCache jwkSetCache;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JWKGenerator&lt;? <span class="hljs-keyword">extends</span> <span class="title class_">JWK</span>&gt; jwkGenerator;</span><br><span class="line">    <span class="hljs-keyword">private</span> KeyIDStrategy keyIDStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RotateJwkSource</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="title class_">InMemoryJWKSetCache</span>(), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RotateJwkSource</span><span class="hljs-params">(JWKSetCache jwkSetCache)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(jwkSetCache, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RotateJwkSource</span><span class="hljs-params">(JWKSetCache jwkSetCache, JWKSource&lt;C&gt; failoverJWKSource)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(jwkSetCache, failoverJWKSource, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RotateJwkSource</span><span class="hljs-params">(JWKSetCache jwkSetCache, JWKGenerator&lt;? extends JWK&gt; jwkGenerator)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(jwkSetCache, <span class="hljs-literal">null</span>, jwkGenerator, <span class="hljs-literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RotateJwkSource</span><span class="hljs-params">(JWKSetCache jwkSetCache, JWKSource&lt;C&gt; failoverJWKSource, JWKGenerator&lt;? extends JWK&gt; jwkGenerator, KeyIDStrategy keyIDStrategy)</span> {</span><br><span class="line">        Assert.notNull(jwkSetCache, <span class="hljs-string">"jwkSetCache cannot be null"</span>);</span><br><span class="line">        <span class="hljs-built_in">this</span>.jwkSetCache = jwkSetCache;</span><br><span class="line">        <span class="hljs-built_in">this</span>.failoverJWKSource = failoverJWKSource;</span><br><span class="line">        <span class="hljs-keyword">if</span> (jwkGenerator == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-built_in">this</span>.jwkGenerator = <span class="hljs-keyword">new</span> <span class="title class_">RSAKeyGenerator</span>(RSAKeyGenerator.MIN_KEY_SIZE_BITS);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-built_in">this</span>.jwkGenerator = jwkGenerator;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (keyIDStrategy == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-built_in">this</span>.keyIDStrategy = <span class="hljs-keyword">new</span> <span class="title class_">TimestampKeyIDStrategy</span>();</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-built_in">this</span>.keyIDStrategy = keyIDStrategy;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> List&lt;JWK&gt; <span class="title function_">get</span><span class="hljs-params">(JWKSelector jwkSelector, C context)</span> <span class="hljs-keyword">throws</span> RotateKeySourceException {</span><br><span class="line">        <span class="hljs-type">JWKSet</span> <span class="hljs-variable">jwkSet</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.jwkSetCache.get();</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.jwkSetCache.requiresRefresh() || jwkSet == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">try</span> {</span><br><span class="line">                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {</span><br><span class="line">                    jwkSet = <span class="hljs-built_in">this</span>.jwkSetCache.get();</span><br><span class="line">                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.jwkSetCache.requiresRefresh() || jwkSet == <span class="hljs-literal">null</span>) {</span><br><span class="line">                        jwkSet = <span class="hljs-built_in">this</span>.updateJWKSet(jwkSet);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">                List&lt;JWK&gt; failoverMatches = <span class="hljs-built_in">this</span>.failover(e, jwkSelector, context);</span><br><span class="line">                <span class="hljs-keyword">if</span> (failoverMatches != <span class="hljs-literal">null</span>) {</span><br><span class="line">                    <span class="hljs-keyword">return</span> failoverMatches;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">if</span> (jwkSet == <span class="hljs-literal">null</span>) {</span><br><span class="line">                    <span class="hljs-keyword">throw</span> e;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        List&lt;JWK&gt; jwks = jwkSelector.select(jwkSet);</span><br><span class="line">        <span class="hljs-keyword">if</span> (!jwks.isEmpty()) {</span><br><span class="line">            <span class="hljs-keyword">return</span> jwks;</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">return</span> Collections.emptyList();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> JWKSet <span class="title function_">updateJWKSet</span><span class="hljs-params">(JWKSet jwkSet)</span> <span class="hljs-keyword">throws</span> RotateKeySourceException {</span><br><span class="line">        JWK jwk;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            jwkGenerator.keyID(keyIDStrategy.generateKeyID());</span><br><span class="line">            jwk = jwkGenerator.generate();</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (JOSEException e) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">RotateKeySourceException</span>(<span class="hljs-string">"Couldn't generate JWK:"</span> + e.getMessage(), e);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-type">JWKSet</span> <span class="hljs-variable">updateJWKSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">JWKSet</span>(jwk);</span><br><span class="line">        <span class="hljs-built_in">this</span>.jwkSetCache.put(updateJWKSet);</span><br><span class="line">        <span class="hljs-keyword">if</span> (jwkSet != <span class="hljs-literal">null</span>) {</span><br><span class="line">            List&lt;JWK&gt; keys = jwkSet.getKeys();</span><br><span class="line">            List&lt;JWK&gt; updateJwks = <span class="hljs-keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(keys);</span><br><span class="line">            updateJwks.add(jwk);</span><br><span class="line">            updateJWKSet = <span class="hljs-keyword">new</span> <span class="title class_">JWKSet</span>(updateJwks);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> updateJWKSet;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> List&lt;JWK&gt; <span class="title function_">failover</span><span class="hljs-params">(Exception exception, JWKSelector jwkSelector, C context)</span> <span class="hljs-keyword">throws</span> RotateKeySourceException {</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getFailoverJWKSource() == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">try</span> {</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getFailoverJWKSource().get(jwkSelector, context);</span><br><span class="line">            } <span class="hljs-keyword">catch</span> (KeySourceException e) {</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">RotateKeySourceException</span>(exception.getMessage() + <span class="hljs-string">"; Failover JWK source retrieval failed with: "</span> + e.getMessage(), e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">setKeyIDStrategy</span><span class="hljs-params">(KeyIDStrategy keyIDStrategy)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.keyIDStrategy = keyIDStrategy;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>RotateJwkSource</code>为包含密钥轮换的<code>JWKSource</code>的实现类，遵循以下步骤：</p>
<ul>
<li><p>首先从<code>JWKSetCache</code>缓存中获取JWKSet（JWKSet仅包含未过期JWK）。本示例中自定义<code>JWKSetCache</code>实现类有<code>InMemoryJWKSetCache</code>，<code>CaffeineJWKSetCache</code>，<code>RedisJWKSetCache</code>。</p>
</li>
<li><p>如果JWKSet不为空或不需要刷新密钥，则通过<code>JWKSelector</code>从指定的 JWK 集中选择与配置的条件匹配的JWK。</p>
</li>
<li><p>否则，执行updateJWKSet(JWKSet jwkSet)生成新的密钥对添加进缓存，并返回新的JWKSet（JWKSet仅包含未过期JWK）。</p>
</li>
</ul>
<blockquote>
<p>JWKSetCache 定义密钥刷新周期及密钥过期时间。</p>
</blockquote>
<p><code>RotateJwkSource</code>属性介绍：</p>
<ul>
<li><strong>failoverJWKSource</strong>：故障转移 JWKSource。</li>
<li><strong>jwkSetCache</strong>：JWKSet缓存接口类，定义密钥刷新周期，密钥过期时间。本示例中提供三种实现类，<code>InMemoryJWKSetCache</code>，<code>CaffeineJWKSetCache</code>，<code>RedisJWKSetCache</code>。</li>
<li><strong>jwkGenerator</strong>：密钥生成器，<code>RotateJwkSource</code>默认使用<code>RSAKeyGenerator</code>。</li>
<li><strong>KeyIDStrategy</strong> ：<code>kid</code>生成策略，本示例中使用时间戳表示<code>kid</code>。</li>
</ul>
<br>





<h5 id="基于本地内存，caffeine，redis的JWKSetCache"><a href="#基于本地内存，caffeine，redis的JWKSetCache" class="headerlink" title="基于本地内存，caffeine，redis的JWKSetCache"></a>基于本地内存，caffeine，redis的JWKSetCache</h5><blockquote>
<p>本示例用于测试需要，密钥刷新周期定为5分钟，密钥过期时间定为15分钟，实际应用中请根据需要修改。</p>
</blockquote>
<p><code>InMemoryJWKSetCache</code>实现方式相对简单。由<code>JWKWithTimestamp</code>存储密钥对，lifespan为密钥过期时间，refreshTime为密钥刷新周期。为确保密钥轮换正常使用，建议 <strong>lifespan &gt;=  refreshTime + exp</strong>。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="title class_">InMemoryJWKSetCache</span> <span class="hljs-keyword">implements</span> <span class="title class_">JWKSetCache</span> {</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> lifespan;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> refreshTime;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Set&lt;JWKWithTimestamp&gt; jwkWithTimestamps;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">InMemoryJWKSetCache</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(<span class="hljs-number">15L</span>, <span class="hljs-number">5L</span>, TimeUnit.MINUTES);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">InMemoryJWKSetCache</span><span class="hljs-params">(<span class="hljs-type">long</span> lifespan, <span class="hljs-type">long</span> refreshTime, TimeUnit timeUnit)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.lifespan = lifespan;</span><br><span class="line">        <span class="hljs-built_in">this</span>.refreshTime = refreshTime;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((lifespan &gt; -<span class="hljs-number">1L</span> || refreshTime &gt; -<span class="hljs-number">1L</span>) &amp;&amp; timeUnit == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="hljs-string">"A time unit must be specified for non-negative lifespans or refresh times"</span>);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-built_in">this</span>.jwkWithTimestamps = <span class="hljs-keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">put</span><span class="hljs-params">(JWKSet jwkSet)</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (jwkSet != <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(jwkSet.getKeys())) {</span><br><span class="line">                List&lt;JWKWithTimestamp&gt; updateJWKWithTs = jwkSet.getKeys().stream().map(JWKWithTimestamp::<span class="hljs-keyword">new</span>)</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                <span class="hljs-built_in">this</span>.jwkWithTimestamps.addAll(updateJWKWithTs);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> JWKSet <span class="title function_">get</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.jwkWithTimestamps) &amp;&amp; !<span class="hljs-built_in">this</span>.isExpired() ? <span class="hljs-keyword">new</span> <span class="title class_">JWKSet</span>(<span class="hljs-built_in">this</span>.jwkWithTimestamps.stream()</span><br><span class="line">                .filter(t -&gt; t.getDate().getTime() + TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.lifespan, <span class="hljs-built_in">this</span>.timeUnit) &gt; (<span class="hljs-keyword">new</span> <span class="title class_">Date</span>()).getTime())</span><br><span class="line">                .map(JWKWithTimestamp::getJwk).collect(Collectors.toList())) : <span class="hljs-literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="title function_">requiresRefresh</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.jwkWithTimestamps) &amp;&amp; <span class="hljs-built_in">this</span>.refreshTime &gt; -<span class="hljs-number">1L</span> &amp;&amp; <span class="hljs-built_in">this</span>.jwkWithTimestamps.stream().map(jwkWithTimestamp -&gt; jwkWithTimestamp.getDate().getTime())</span><br><span class="line">                .max(Long::compareTo)</span><br><span class="line">                .filter(time -&gt; (<span class="hljs-keyword">new</span> <span class="title class_">Date</span>()).getTime() &gt; time + TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.refreshTime, <span class="hljs-built_in">this</span>.timeUnit))</span><br><span class="line">                .isPresent();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="title function_">isExpired</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.jwkWithTimestamps) &amp;&amp; <span class="hljs-built_in">this</span>.lifespan &gt; -<span class="hljs-number">1L</span> &amp;&amp; <span class="hljs-built_in">this</span>.jwkWithTimestamps.stream().map(jwkWithTimestamp -&gt; jwkWithTimestamp.getDate().getTime())</span><br><span class="line">                .max(Long::compareTo)</span><br><span class="line">                .filter(time -&gt; (<span class="hljs-keyword">new</span> <span class="title class_">Date</span>()).getTime() &gt; time + TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.lifespan, <span class="hljs-built_in">this</span>.timeUnit))</span><br><span class="line">                .isPresent();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="title function_">getLifespan</span><span class="hljs-params">(TimeUnit timeUnit)</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.lifespan &lt; <span class="hljs-number">0L</span> ? <span class="hljs-built_in">this</span>.lifespan : timeUnit.convert(<span class="hljs-built_in">this</span>.lifespan, <span class="hljs-built_in">this</span>.timeUnit);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="title function_">getRefreshTime</span><span class="hljs-params">(TimeUnit timeUnit)</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.refreshTime &lt; <span class="hljs-number">0L</span> ? <span class="hljs-built_in">this</span>.refreshTime : timeUnit.convert(<span class="hljs-built_in">this</span>.refreshTime, <span class="hljs-built_in">this</span>.timeUnit);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><code>InMemoryJWKSetCache</code>中put方法将密钥对及当前时间封装为<code>JWKWithTimestamp</code>并添加到<code>LinkedHashSet</code>。get方法从<code>LinkedHashSet</code>过滤获取未过期JWK并返回。</p>
<p>此方式中并没有对过期密钥进行清除操作。</p>
<br>

<p><a target="_blank" rel="noopener" href="https://github.com/ben-manes/caffeine">Caffeine</a> — 一个<strong>用于 Java 的高性能缓存库</strong>。<code>CaffeineJWKSetCache</code>基于Caffeine实现密钥存储。lifespan为密钥过期时间，refreshTime为密钥刷新周期。建议 <strong>lifespan &gt;=  refreshTime + exp</strong>。</p>
<p>Caffeine三种缓存填充策略：手动、同步加载和异步加载。其中我们选用手动填充将密钥放入缓存中，并在get()中检索它们。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="title class_">CaffeineJWKSetCache</span> <span class="hljs-keyword">implements</span> <span class="title class_">JWKSetCache</span> {</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> lifespan;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> refreshTime;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;Long, JWK&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">CaffeineJWKSetCache</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(<span class="hljs-number">15L</span>, <span class="hljs-number">5L</span>, TimeUnit.MINUTES);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">CaffeineJWKSetCache</span><span class="hljs-params">(<span class="hljs-type">long</span> lifespan, <span class="hljs-type">long</span> refreshTime, TimeUnit timeUnit)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.lifespan = lifespan;</span><br><span class="line">        <span class="hljs-built_in">this</span>.refreshTime = refreshTime;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((lifespan &gt; -<span class="hljs-number">1L</span> || refreshTime &gt; -<span class="hljs-number">1L</span>) &amp;&amp; timeUnit == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="hljs-string">"A time unit must be specified for non-negative lifespans or refresh times"</span>);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        }</span><br><span class="line">        Caffeine&lt;Object, Object&gt; caffeine = Caffeine.newBuilder().maximumSize(<span class="hljs-number">10</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span> (lifespan &gt; -<span class="hljs-number">1L</span>) {</span><br><span class="line">            caffeine.expireAfterWrite(<span class="hljs-built_in">this</span>.lifespan, <span class="hljs-built_in">this</span>.timeUnit);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-built_in">this</span>.cache = caffeine.build();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">put</span><span class="hljs-params">(JWKSet jwkSet)</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (jwkSet != <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(jwkSet.getKeys())) {</span><br><span class="line">                jwkSet.getKeys().forEach(jwk -&gt; cache.put(<span class="hljs-keyword">new</span> <span class="title class_">Date</span>().getTime(), jwk));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> JWKSet <span class="title function_">get</span><span class="hljs-params">()</span> {</span><br><span class="line">        List&lt;<span class="hljs-meta">@NonNull</span> JWK&gt; jwks = <span class="hljs-keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(cache.asMap().values());</span><br><span class="line">        <span class="hljs-keyword">return</span> CollectionUtils.isEmpty(jwks) ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">new</span> <span class="title class_">JWKSet</span>(jwks);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="title function_">requiresRefresh</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.refreshTime &gt; -<span class="hljs-number">1L</span> &amp;&amp; cache.asMap().keySet().stream()</span><br><span class="line">                .max(Long::compareTo)</span><br><span class="line">                .filter(time -&gt; (<span class="hljs-keyword">new</span> <span class="title class_">Date</span>()).getTime() &gt; time + TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.refreshTime, <span class="hljs-built_in">this</span>.timeUnit))</span><br><span class="line">                .isPresent();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>







<br>

<p><a target="_blank" rel="noopener" href="http://redis.io/">Redis</a> — 流行的内存数据结构存储。<code>RedisJWKSetCache</code>使用Redis有序集合(sorted set)存储密钥，scope为密钥放进缓存的时间。</p>
<p>Redis有序集合不支持对单个元素设置过期时间，所以我们将通过使用scope存储密钥缓存时间，并在每次更新缓存时计算已过期密钥，使用<code>zRemRangeByScore</code>命令移除已过期密钥。建议 <strong>lifespan &gt;=  refreshTime + exp</strong>。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="title class_">RedisJWKSetCache</span> <span class="hljs-keyword">implements</span> <span class="title class_">JWKSetCache</span> {</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">springDataRedis_2_0</span> <span class="hljs-operator">=</span> ClassUtils.isPresent(<span class="hljs-string">"org.springframework.data.redis.connection.RedisStandaloneConfiguration"</span>, RedisJWKSetCache.class.getClassLoader());</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisConnectionFactory connectionFactory;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">JWK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jwks"</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> RedisSerializer&lt;String&gt; redisSerializeKey = <span class="hljs-keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">    <span class="hljs-keyword">private</span> RedisSerializer&lt;String&gt; redisSerializerValue = <span class="hljs-keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(String.class);</span><br><span class="line">    <span class="hljs-keyword">private</span> Method redisConnectionSet_2_0;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> lifespan;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> refreshTime;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RedisJWKSetCache</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>(<span class="hljs-number">15L</span>, <span class="hljs-number">5L</span>, TimeUnit.MINUTES, connectionFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="title function_">RedisJWKSetCache</span><span class="hljs-params">(<span class="hljs-type">long</span> lifespan, <span class="hljs-type">long</span> refreshTime, TimeUnit timeUnit, RedisConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.lifespan = lifespan;</span><br><span class="line">        <span class="hljs-built_in">this</span>.refreshTime = refreshTime;</span><br><span class="line">        <span class="hljs-keyword">if</span> ((lifespan &gt; -<span class="hljs-number">1L</span> || refreshTime &gt; -<span class="hljs-number">1L</span>) &amp;&amp; timeUnit == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="hljs-string">"A time unit must be specified for non-negative lifespans or refresh times"</span>);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        }</span><br><span class="line">        Assert.notNull(connectionFactory, <span class="hljs-string">"redisConnectionFactory cannot be null"</span>);</span><br><span class="line">        <span class="hljs-built_in">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">        <span class="hljs-keyword">if</span> (springDataRedis_2_0) {</span><br><span class="line">            <span class="hljs-built_in">this</span>.loadRedisConnectionMethods_2_0();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">put</span><span class="hljs-params">(JWKSet jwkSet)</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (jwkSet != <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(jwkSet.getKeys())) {</span><br><span class="line">                <span class="hljs-type">RedisConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConnection();</span><br><span class="line">                <span class="hljs-type">byte</span>[] key = <span class="hljs-built_in">this</span>.serializeKey(JWK_KEY);</span><br><span class="line"></span><br><span class="line">                connection.openPipeline();</span><br><span class="line"></span><br><span class="line">                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.lifespan &gt; -<span class="hljs-number">1</span>) {</span><br><span class="line">                    <span class="hljs-type">long</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">Date</span>().getTime() - TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.lifespan, <span class="hljs-built_in">this</span>.timeUnit);</span><br><span class="line">                    connection.zRemRangeByScore(key, Range.range().lte(max));</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                List&lt;JWK&gt; keys = jwkSet.getKeys();</span><br><span class="line">                <span class="hljs-keyword">try</span> {</span><br><span class="line">                    <span class="hljs-keyword">for</span> (JWK jwk : keys) {</span><br><span class="line">                        <span class="hljs-type">byte</span>[] value = <span class="hljs-built_in">this</span>.serialize(jwk.toJSONString());</span><br><span class="line"></span><br><span class="line">                        <span class="hljs-keyword">if</span> (springDataRedis_2_0) {</span><br><span class="line">                            <span class="hljs-keyword">try</span> {</span><br><span class="line">                                <span class="hljs-built_in">this</span>.redisConnectionSet_2_0.invoke(connection, key, <span class="hljs-keyword">new</span> <span class="title class_">Date</span>().getTime(), value);</span><br><span class="line">                            } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="hljs-keyword">else</span> {</span><br><span class="line">                            connection.zAdd(key, <span class="hljs-keyword">new</span> <span class="title class_">Date</span>().getTime(), value);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    connection.closePipeline();</span><br><span class="line">                } <span class="hljs-keyword">finally</span> {</span><br><span class="line">                    connection.close();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> JWKSet <span class="title function_">get</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-type">RedisConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConnection();</span><br><span class="line">        <span class="hljs-type">byte</span>[] key = <span class="hljs-built_in">this</span>.serializeKey(JWK_KEY);</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            <span class="hljs-type">Long</span> <span class="hljs-variable">efficientCount</span> <span class="hljs-operator">=</span> Optional.ofNullable(connection.zCard(key)).orElse(<span class="hljs-number">0L</span>);</span><br><span class="line">            <span class="hljs-keyword">if</span> (efficientCount &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">                Set&lt;<span class="hljs-type">byte</span>[]&gt; jwkBytes = connection.zRevRangeByScore(key, Range.range());</span><br><span class="line">                List&lt;JWK&gt; jwks = jwkBytes.stream().map(<span class="hljs-built_in">this</span>::deserialize).map(<span class="hljs-built_in">this</span>::parse).collect(Collectors.toList());</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">JWKSet</span>(jwks);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">        } <span class="hljs-keyword">finally</span> {</span><br><span class="line">            connection.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> JWK <span class="title function_">parse</span><span class="hljs-params">(String jwkJsonString)</span> {</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            <span class="hljs-keyword">return</span> JWK.parse(jwkJsonString);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (ParseException e) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="title function_">requiresRefresh</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-type">RedisConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConnection();</span><br><span class="line">        <span class="hljs-type">byte</span>[] key = <span class="hljs-built_in">this</span>.serializeKey(<span class="hljs-string">"jwks"</span>);</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            <span class="hljs-type">Long</span> <span class="hljs-variable">efficientCount</span> <span class="hljs-operator">=</span> Optional.ofNullable(connection.zCard(key)).orElse(<span class="hljs-number">0L</span>);</span><br><span class="line">            Set&lt;Tuple&gt; maximumScoreTuple = connection.zRevRangeByScoreWithScores(key, Range.range(), Limit.limit().count(<span class="hljs-number">1</span>));</span><br><span class="line"></span><br><span class="line">            <span class="hljs-type">long</span> <span class="hljs-variable">lastRefreshTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(maximumScoreTuple)) {</span><br><span class="line">                lastRefreshTime = maximumScoreTuple.stream().findFirst().orElse(<span class="hljs-keyword">new</span> <span class="title class_">DefaultTuple</span>(<span class="hljs-literal">null</span>, <span class="hljs-number">0.0</span>)).getScore().longValue();</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-keyword">return</span> efficientCount &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">this</span>.refreshTime &gt; -<span class="hljs-number">1L</span> &amp;&amp; (<span class="hljs-keyword">new</span> <span class="title class_">Date</span>()).getTime() &gt; lastRefreshTime + TimeUnit.MILLISECONDS.convert(<span class="hljs-built_in">this</span>.refreshTime, <span class="hljs-built_in">this</span>.timeUnit);</span><br><span class="line">        } <span class="hljs-keyword">finally</span> {</span><br><span class="line">            connection.close();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] serializeKey(String key) {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.redisSerializeKey.serialize(<span class="hljs-built_in">this</span>.prefix + key);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] serialize(String value) {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.redisSerializerValue.serialize(value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String <span class="title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.redisSerializerValue.deserialize(bytes);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="title function_">loadRedisConnectionMethods_2_0</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.redisConnectionSet_2_0 = ReflectionUtils.findMethod(RedisConnection.class, <span class="hljs-string">"zAdd"</span>, <span class="hljs-keyword">new</span> <span class="title class_">Class</span>[]{<span class="hljs-type">byte</span>[].class, <span class="hljs-type">double</span>.class, <span class="hljs-type">byte</span>[].class});</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> RedisConnection <span class="title function_">getConnection</span><span class="hljs-params">()</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.connectionFactory.getConnection();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">setPrefix</span><span class="hljs-params">(String prefix)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.prefix = prefix;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">setRedisSerializerKey</span><span class="hljs-params">(RedisSerializer&lt;String&gt; redisSerializer)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.redisSerializeKey = redisSerializer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="title function_">setRedisSerializerValue</span><span class="hljs-params">(RedisSerializer&lt;String&gt; redisSerializer)</span> {</span><br><span class="line">        <span class="hljs-built_in">this</span>.redisSerializerValue = redisSerializer;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><br><br></p>
<p>介绍完本示例中密钥轮换实现逻辑，接下来让我们配置<code>RotateJwkSource</code>应用于授权服务：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-keyword">public</span> JWKSource&lt;SecurityContext&gt; <span class="title function_">jwkSource</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {</span><br><span class="line">    <span class="hljs-type">RedisJWKSetCache</span> <span class="hljs-variable">redisJWKSetCache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">RedisJWKSetCache</span>(connectionFactory);</span><br><span class="line">    redisJWKSetCache.setPrefix(<span class="hljs-string">"auth-server"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">RotateJwkSource</span>&lt;&gt;(redisJWKSetCache);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<br>

<p>是否记得前面提到的<strong>避免客户端发送使用以前颁发的密钥签名的 JWT 的验证失败潜在问题，在令牌完全过期之前，我们需要在一段时间内保持两个密钥</strong>。所以授权服务在签发JWT令牌时，由于某一段时间存在多个密钥，因此在<code>JwtEncoder</code>生成JWT时将提示以下错误信息：</p>
<figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.security.oauth2.jwt.JwtEncodingException: An error occurred while attempting to encode the Jwt: Found multiple JWK signing keys for algorithm 'RS256'</span><br></pre></td></tr></tbody></table></figure>



<p>所以我们需要生成JWT前指定<code>kid</code>属性, <code>JWKSelector</code>将从指定的 JWKS 中选择与<code>kid</code>相对应的JWK用于生成JWT。Spring Authorization Server中<code>OAuth2TokenCustomizer</code>提供了自定义属性的能力，根据密钥轮换策略，我们需要使用最新密钥生成JWT，<code>RotateJwkSource</code>中kid生成策略由时间戳定义，所以JWKS中最新的密钥将会是最大值<code>kid</code>对应的密钥，我们将获取最大值<code>kid</code>放入JWT的Header中。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-keyword">public</span> OAuth2TokenCustomizer&lt;JwtEncodingContext&gt; <span class="title function_">tokenCustomizer</span><span class="hljs-params">(JWKSource&lt;SecurityContext&gt; jwkSource)</span> {</span><br><span class="line">    <span class="hljs-keyword">return</span> (context) -&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (OAuth2TokenType.ACCESS_TOKEN.equals(context.getTokenType()) ||</span><br><span class="line">                OidcParameterNames.ID_TOKEN.equals(context.getTokenType().getValue())) {</span><br><span class="line"></span><br><span class="line">            <span class="hljs-type">JWKSelector</span> <span class="hljs-variable">jwkSelector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">JWKSelector</span>(<span class="hljs-keyword">new</span> <span class="title class_">JWKMatcher</span>.Builder().build());</span><br><span class="line">            List&lt;JWK&gt; jwks;</span><br><span class="line">            <span class="hljs-keyword">try</span> {</span><br><span class="line">                jwks = jwkSource.get(jwkSelector, <span class="hljs-literal">null</span>);</span><br><span class="line">            } <span class="hljs-keyword">catch</span> (KeySourceException e) {</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="hljs-string">"Failed to select the JWK(s) -&gt; "</span> + e.getMessage(), e);</span><br><span class="line">            }</span><br><span class="line">            <span class="hljs-type">String</span> <span class="hljs-variable">kid</span> <span class="hljs-operator">=</span> jwks.stream().map(JWK::getKeyID)</span><br><span class="line">                    .max(String::compareTo)</span><br><span class="line">                    .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="hljs-string">"kid not found"</span>));</span><br><span class="line">            context.getHeaders().keyId(kid);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>本示例中kid由时间戳定义，所以确保密钥轮换后使用最新密钥，我们将获取最大值kid所对应的密钥进行签名。但是kid若不使用类似于时间戳的递增值，将建议按照FIFO（先进先出）结构，其格式是将新生成的密钥推送到末尾。</p>
</blockquote>
<br>

<p>最后让我们配置Form表单认证方式,并设置用户名和密码：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line">SecurityFilterChain <span class="title function_">defaultSecurityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {</span><br><span class="line">    http.authorizeHttpRequests((authorize) -&gt; authorize.anyRequest().authenticated())</span><br><span class="line">            .formLogin(Customizer.withDefaults());</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> http.build();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line">UserDetailsService <span class="title function_">userDetailsService</span><span class="hljs-params">()</span> {</span><br><span class="line">    <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"admin"</span>)</span><br><span class="line">            .password(<span class="hljs-string">"{noop}password"</span>)</span><br><span class="line">            .roles(<span class="hljs-string">"ADMIN"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(userDetails);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>









<h3 id="配置资源服务"><a href="#配置资源服务" class="headerlink" title="配置资源服务"></a>配置资源服务</h3><p>本节中我们将使用<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html">Spring Security</a>搭建OAuth2资源服务，并且我们将为<code>JwtDecoder</code>配置redis缓存。</p>
<h4 id="Maven依赖-1"><a href="#Maven依赖-1" class="headerlink" title="Maven依赖"></a>Maven依赖</h4><figure class="highlight plaintext hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.6.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.6.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.6.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.6.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.6.7&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>





<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>首先我们从<code>application.yml</code>文件配置开始，指定端口8090，并添加redis配置和OAuth2配置信息：</p>
<figure class="highlight yaml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">server:</span></span><br><span class="line">  <span class="hljs-attr">port:</span> <span class="hljs-number">8090</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">redis:</span></span><br><span class="line">    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span></span><br><span class="line">    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span></span><br><span class="line">    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span></span><br><span class="line">    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800</span></span><br><span class="line">    <span class="hljs-attr">lettuce:</span></span><br><span class="line">      <span class="hljs-attr">pool:</span></span><br><span class="line">        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span></span><br><span class="line">        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60</span></span><br><span class="line">        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span></span><br><span class="line">        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span></span><br><span class="line">      <span class="hljs-attr">shutdown-timeout:</span> <span class="hljs-number">100</span></span><br><span class="line">  <span class="hljs-attr">security:</span></span><br><span class="line">    <span class="hljs-attr">oauth2:</span></span><br><span class="line">      <span class="hljs-attr">resourceserver:</span></span><br><span class="line">        <span class="hljs-attr">jwt:</span></span><br><span class="line">          <span class="hljs-attr">jwk-set-uri:</span> <span class="hljs-string">http://127.0.0.1:8080/oauth2/jwks</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<br>

<p>Spring Boot 自动配置一个具有默认缓存配置的<em>RedisCacheManager 。</em>但是，我们可以在缓存管理器初始化之前修改此配置，将缓存过期时间设置为<strong>5分钟</strong>。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory factory)</span> {</span><br><span class="line">    RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">    <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">    om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">    jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">    <span class="hljs-comment">// 配置序列化（解决乱码的问题）,过期时间5分钟</span></span><br><span class="line">    <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">            .entryTtl(Duration.ofSeconds(<span class="hljs-number">5</span>*<span class="hljs-number">60</span>))</span><br><span class="line">            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class="line">            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class="line">            .disableCachingNullValues();</span><br><span class="line">    <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> RedisCacheManager.builder(factory)</span><br><span class="line">            .cacheDefaults(config)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="hljs-keyword">return</span> cacheManager;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<br>

<p>阅读到这里，你是否有疑问授权服务轮换密钥后资源服务如何获取最新密钥验证JWT。</p>
<p>在此之前让我们先了解下<code>JwtDecoder</code>工作原理，以下是简单声明<code>JwtDecoder</code>的示例：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-keyword">public</span> JwtDecoder <span class="title function_">jwtDecoder</span><span class="hljs-params">()</span> {</span><br><span class="line">    <span class="hljs-keyword">return</span> NimbusJwtDecoder.withJwkSetUri(jwkSetUri).build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>为了清楚起见，部分源码细节已被省略。</p>
</blockquote>
<p>当我们查看源码NimbusJwtDecoder.JwkSetUriJwtDecoderBuilder构建器中，可以看到内部创建了<code>JWKSource</code>的实现类<code>RemoteJWKSet</code>，注意我们没有配置Cache，所以最终执行<code>return new RemoteJWKSet(toURL(this.jwkSetUri), jwkSetRetriever);</code>。这里<code>ResourceRetriever</code>实现类为<code>RestOperationsResourceRetriever</code>。</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">JWKSource&lt;SecurityContext&gt; <span class="title function_">jwkSource</span><span class="hljs-params">(ResourceRetriever jwkSetRetriever)</span> {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cache == <span class="hljs-literal">null</span>) {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">RemoteJWKSet</span>(toURL(<span class="hljs-built_in">this</span>.jwkSetUri), jwkSetRetriever);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-type">ResourceRetriever</span> <span class="hljs-variable">cachingJwkSetRetriever</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="title class_">NimbusJwtDecoder</span>.JwkSetUriJwtDecoderBuilder.CachingResourceRetriever(<span class="hljs-built_in">this</span>.cache, jwkSetRetriever);</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">RemoteJWKSet</span>(toURL(<span class="hljs-built_in">this</span>.jwkSetUri), cachingJwkSetRetriever, <span class="hljs-keyword">new</span> <span class="title class_">NimbusJwtDecoder</span>.JwkSetUriJwtDecoderBuilder.NoOpJwkSetCache());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>





<p><code>JwtDecoder</code>验证JWT需要通过<code>RemoteJWKSet</code>获取JWK， <code>RemoteJWKSet</code>由 JWKS URL 指定的远程 JSON Web KEY (JWK) 端点。检索到的 JWKS将被缓存以最小化网络调用。每当<code>JWKSelector</code>尝试获取具有未知 <code>kid</code>时，都会更新缓存。以下为<code>RemoteJWKSet</code>核心方法：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> List&lt;JWK&gt; <span class="title function_">get</span><span class="hljs-params">(JWKSelector jwkSelector, C context)</span> <span class="hljs-keyword">throws</span> RemoteKeySourceException {</span><br><span class="line">    <span class="hljs-type">JWKSet</span> <span class="hljs-variable">jwkSet</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.jwkSetCache.get();</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.jwkSetCache.requiresRefresh() || jwkSet == <span class="hljs-literal">null</span>) {</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            jwkSet = <span class="hljs-built_in">this</span>.updateJWKSetFromURL();</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception var6) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (jwkSet == <span class="hljs-literal">null</span>) {</span><br><span class="line">                <span class="hljs-keyword">throw</span> var6;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    List&lt;JWK&gt; matches = jwkSelector.select(jwkSet);</span><br><span class="line">    <span class="hljs-keyword">if</span> (!matches.isEmpty()) {</span><br><span class="line">        <span class="hljs-keyword">return</span> matches;</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-type">String</span> <span class="hljs-variable">soughtKeyID</span> <span class="hljs-operator">=</span> getFirstSpecifiedKeyID(jwkSelector.getMatcher());</span><br><span class="line">        <span class="hljs-keyword">if</span> (soughtKeyID == <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">return</span> Collections.emptyList();</span><br><span class="line">        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jwkSet.getKeyByKeyId(soughtKeyID) != <span class="hljs-literal">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">return</span> Collections.emptyList();</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            jwkSet = <span class="hljs-built_in">this</span>.updateJWKSetFromURL();</span><br><span class="line">            <span class="hljs-type">return</span> <span class="hljs-variable">jwkSet</span> <span class="hljs-operator">=</span>= <span class="hljs-literal">null</span> ? Collections.emptyList() : jwkSelector.select(jwkSet);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>RemoteJWKSet</code>遵循以下步骤：</p>
<ul>
<li>从<code>JWKSetCache</code>获取JWKSet，<code>RemoteJWKSet</code>中默认实现为<code>DefaultJWKSetCache</code>，默认情况<code>DefaultJWKSetCache</code>将授权服务器的 JWKS 缓存 5 分钟。</li>
<li>若<code>JWKSetCache</code>中JWKSet为空或者需要刷新JWK更新缓存时，<code>RestOperationsResourceRetriever</code>将发起HTTP请求向授权服务获取JWKS。</li>
<li><code>JWKSelector</code>从指定的 JWKS中选择与配置的条件匹配的JWK。若匹配为空则将重新通过<code>RestOperationsResourceRetrieve</code>向授权服务请求获取JWKS，再次匹配结果为空则返回空值。</li>
</ul>
<br>

<p>通过简要了解<code>RemoteJWKSet</code>执行过程，我相信对于之前授权服务器轮换密钥后资源服务如何获取最新密钥已经有了答案。</p>
<p>在授权服务密钥轮换后生成JWT的Header中<code>kid</code>使用的是当前最新密钥所对应的<code>kid</code>，此时资源服务收到JWT，通过<code>RemoteJWKSet</code>获取JWK用于验证JWT时，<code>JWKSelector</code>从<code>JWKSetCache</code>返回的JWKS中并没有匹配到条件相符的JWK，所以将会使用<code>RestOperationsResourceRetrieve</code>重新向授权服务获取最新JWKS，<code>JWKSelector</code>将再次选择与条件相符的JWK。</p>
<p>但是分布式系统中协作服务器数量的增加，授权服务密钥轮换后，涉及资源服务都要重新请求授权服务获取最新JWK，当然这并不会对授权服务造成太大压力。但是为了最小化网络调用，本示例使用共享缓存解决此问题。</p>
<br>

<p>接下来我们将为<code>JwtDecoder</code>配置Redis缓存，Redis将使用 JWKS Uri 作为键，并使用 JWKS  JSON 作为值:</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line">JwtDecoder <span class="title function_">jwtDecoder</span><span class="hljs-params">(OAuth2ResourceServerProperties properties, RestOperations restOperations, CacheManager cacheManager)</span> {</span><br><span class="line">    <span class="hljs-type">NimbusJwtDecoder</span> <span class="hljs-variable">jwtDecoder</span> <span class="hljs-operator">=</span> NimbusJwtDecoder.withJwkSetUri(properties.getJwt().getJwkSetUri())</span><br><span class="line">            .restOperations(restOperations)</span><br><span class="line">            .cache(cacheManager.getCache(<span class="hljs-string">"jwks"</span>))</span><br><span class="line">            .jwsAlgorithms(algorithms -&gt; {</span><br><span class="line">                algorithms.add(RS256);</span><br><span class="line">            }).build();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">//自定义时间戳验证</span></span><br><span class="line">    OAuth2TokenValidator&lt;Jwt&gt; withClockSkew = <span class="hljs-keyword">new</span> <span class="title class_">DelegatingOAuth2TokenValidator</span>&lt;&gt;(</span><br><span class="line">            <span class="hljs-keyword">new</span> <span class="title class_">JwtTimestampValidator</span>(Duration.ofSeconds(<span class="hljs-number">60</span>)));</span><br><span class="line"></span><br><span class="line">    jwtDecoder.setJwtValidator(withClockSkew);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> jwtDecoder;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时<code>RemoteJWKSet</code>的ResourceRetriever属性实际赋值为<code>CachingResourceRetriever</code>, 我们使用的是Redis缓存，<code>CachingResourceRetriever</code>中更新JWKS会先从Redis缓存中获取，若Redis缓存为空则将请求授权服务，部分源码如下：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> Resource <span class="title function_">retrieveResource</span><span class="hljs-params">(URL url)</span> <span class="hljs-keyword">throws</span> IOException {</span><br><span class="line">    <span class="hljs-type">String</span> <span class="hljs-variable">jwkSet</span> <span class="hljs-operator">=</span> (String)<span class="hljs-built_in">this</span>.cache.get(url.toString(), () -&gt; {</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.resourceRetriever.retrieveResource(url).getContent();</span><br><span class="line">    });</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="title class_">Resource</span>(jwkSet, <span class="hljs-string">"UTF-8"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>这里引出一个新的问题，Redis缓存为空才会重新请求授权服务JWKS Uri，如果某个时刻授权服务密钥轮换后，资源服务Redis缓存此时存在值，则不会重新向授权服务发起请求来更新资源服务JWKS缓存，此时资源服务验证轮换后的密钥生成的JWT将会失败。</p>
<p>解决此问题我们可以在授权服务密钥轮换后清除Redis中资源服务JWKS缓存信息。</p>
<br>

<p>最后我们将使用Spring Security保护资源服务端点，指定受保护端点访问权限：</p>
<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line">SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {</span><br><span class="line">    http.authorizeHttpRequests((authorize) -&gt; authorize</span><br><span class="line">            .antMatchers(<span class="hljs-string">"/resource/article"</span>).hasAuthority(<span class="hljs-string">"SCOPE_message.read"</span>)</span><br><span class="line">            .anyRequest().authenticated())</span><br><span class="line">            .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> http.build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@RestController</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="title class_">ArticleController</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@GetMapping("/resource/article")</span></span><br><span class="line">    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getArticle</span><span class="hljs-params">(<span class="hljs-meta">@AuthenticationPrincipal</span> Jwt jwt)</span> {</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="hljs-string">"principal"</span>, jwt.getClaims());</span><br><span class="line">        result.put(<span class="hljs-string">"article"</span>, Arrays.asList(<span class="hljs-string">"article1"</span>, <span class="hljs-string">"article2"</span>, <span class="hljs-string">"article3"</span>));</span><br><span class="line">        <span class="hljs-keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="测试我们的应用程序"><a href="#测试我们的应用程序" class="headerlink" title="测试我们的应用程序"></a>测试我们的应用程序</h3><p>本文中并没有说明客户端服务创建，客户端服务并不是本文介绍重点，若有疑问可以参考之前文章或者通过文末链接获取源码。</p>
<p>接下来我们将启动所有服务并访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8070/client/article">http://127.0.0.1:8070/client/article</a> 。在等待授权服务轮换密钥后，访问依旧正常。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>与往常一样，本文中使用的源代码可<a target="_blank" rel="noopener" href="https://github.com/ReLive27/spring-security-oauth2-sample/tree/main/oauth2-jwk-redis">在 GitHub 上</a>获得。</p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/spring-security/">#spring security</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2022/08/13/spring-gateway-oauth2/">将Spring Cloud Gateway 与OAuth2模式一起使用</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 ReLive27&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/ReLive27">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery > p > .gallery-item').unwrap();
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站内搜索" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>