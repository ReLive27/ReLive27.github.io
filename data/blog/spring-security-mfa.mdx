---
title: Spring Security å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
date: 2023-02-26 14:24:01
tags: ['SpringSecurity']
draft: false
authors: ['default']
---

å¤šå› ç´ èº«ä»½éªŒè¯æ˜¯ä¸€ç§æé«˜äº§å“å®‰å…¨æ€§çš„æ–¹æ³•ï¼Œå®ƒé€šè¿‡è¦æ±‚ç”¨æˆ·æä¾›é™¤ç”¨æˆ·åå’Œå¯†ç ä¹‹å¤–çš„ç¬¬äºŒç§å½¢å¼çš„èº«ä»½éªŒè¯æ¥å¢åŠ é¢å¤–çš„å®‰å…¨å±‚ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ TOTPï¼ˆåŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç ï¼‰ä½œä¸ºç¬¬äºŒç§èº«ä»½è¯†åˆ«å½¢å¼ã€‚æ­¤ TOTP ç”±ç”¨æˆ·ç§»åŠ¨è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºç”Ÿæˆï¼Œä¾‹å¦‚ Google èº«ä»½éªŒè¯å™¨ã€‚

> ğŸ’¡ æ³¨æ„ï¼šå¦‚æœä¸æƒ³è¯»åˆ°æœ€åï¼Œå¯ä»¥åœ¨è¿™é‡Œ[æŸ¥çœ‹æºç ](https://github.com/ReLive27/spring-security-sample/tree/master/mfa-login)ã€‚å–œæ¬¢çš„è¯åˆ«å¿˜äº†ç»™é¡¹ç›®ä¸€ä¸ªstarå“¦ï¼

## å¤šå› ç´ èº«ä»½éªŒè¯çš„å·¥ä½œåŸç†

å½“ç”¨æˆ·å¯ç”¨å¤šå› ç´ èº«ä»½éªŒè¯æ—¶ï¼Œå°†ç”Ÿæˆä¸€ä¸ªå¯†é’¥å¹¶ä»¥ QR ç çš„å½¢å¼å‘é€ç»™ç”¨æˆ·ï¼Œç”¨æˆ·å°†ä½¿ç”¨èº«ä»½éªŒè¯å™¨åº”ç”¨ç¨‹åºå¯¹å…¶è¿›è¡Œæ‰«æã€‚

ç™»å½•è¿‡ç¨‹ç°åœ¨éœ€è¦å‡ ä¸ªæ­¥éª¤ï¼š

1.ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚<br />
2.èº«ä»½éªŒè¯æœåŠ¡éªŒè¯ç”¨æˆ·åå’Œå¯†ç ã€‚<br />
3.ç”¨æˆ·é€šè¿‡èº«ä»½éªŒè¯å™¨åº”ç”¨ç¨‹åºæ‰«æ QR ç ã€‚<br />
4.ç”¨æˆ·è¾“å…¥éªŒè¯å™¨åº”ç”¨ç¨‹åºç”Ÿæˆçš„ä¸€æ¬¡æ€§å¯†ç ã€‚<br />
5.èº«ä»½éªŒè¯æœåŠ¡ä½¿ç”¨ç”Ÿæˆçš„å¯†é’¥éªŒè¯ä¸€æ¬¡æ€§å¯†ç ï¼Œå¹¶å°† JWT ä»¤ç‰Œå‘é€ç»™ç”¨æˆ·ã€‚<br />

è®©æˆ‘ä»¬æ·±å…¥äº†è§£å®æ–½ã€‚

## ä¸€æ¬¡æ€§å¯†ç ç®¡ç†å™¨

æˆ‘ä»¬åœ¨ pom.xml æ–‡ä»¶ä¸­å¼•å…¥[è¯¥åº“](https://github.com/samdjstevens/java-totp) ç”¨äºç”Ÿæˆå¯†é’¥å¹¶éªŒè¯ä¸€æ¬¡æ€§å¯†ç ã€‚

```xml
<dependency>
    <groupId>dev.samstevens.totp</groupId>
    <artifactId>totp-spring-boot-starter</artifactId>
    <version>1.7.1</version>
</dependency>
```

DefaultTotpManager åŒ…è£…äº†TOTPåº“ï¼Œå®ƒæœ‰ä»¥ä¸‹æ“ä½œï¼š

```java
public class DefaultTotpManager implements MfaAuthenticationManager {

    @Override
    public String generateSecret() {}

    @Override
    public String getUriForImage(String label, String secret, String issuer) throws QrGenerationException {}

    @Override
    public boolean validCode(String secret, String code) {}
}
```
é¦–å…ˆï¼Œç”Ÿæˆå¯†é’¥ï¼Œç¬¬äºŒï¼Œç”Ÿæˆå¯†é’¥çš„äºŒç»´ç å›¾åƒ URIï¼Œæœ€åï¼ŒvalidCode éªŒè¯æä¾›çš„ä»£ç æ˜¯æ­£ç¡®çš„è¿˜æ˜¯é”™è¯¯çš„ä»£ç ã€‚

è¿™äº›æ–¹æ³•çš„å®ç°æ˜¯ç›´æ¥ä½¿ç”¨ TOPT åº“ã€‚


## ä¸€æ¬¡æ€§å¯†ç éªŒè¯æµç¨‹

æäº¤ä¸€æ¬¡æ€§å¯†ç åï¼Œ`MfaAuthenticationFilter` å°†å¯¹ä¸€æ¬¡æ€§å¯†ç è¿›è¡ŒéªŒè¯ï¼Œæˆ‘ä»¬éµå¾ª Spring Security çš„è®¤è¯æ¶æ„ï¼Œ
å› æ­¤ä¸‹å›¾çœ‹èµ·æ¥åº”è¯¥éå¸¸ç›¸ä¼¼ [AbstractAuthenticationProcessingFilter](https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html#servlet-authentication-abstractprocessingfilter) :

![](../static/images/blogs/mfa-process.png)

**1**: å½“ç”¨æˆ·æäº¤ä¸€æ¬¡æ€§å¯†ç æ—¶ï¼Œåœ¨å®ä¾‹ `MfaAuthenticationFilter` é€šè¿‡ `MfaAuthenticationConverter` ä» `HttpServletRequest` åˆ›å»ºä¸€ä¸ª `MfaAuthenticationToken` ï¼Œè¿™æ˜¯ä¸€ç§`Authentication`ç±»å‹ã€‚
`MfaAuthenticationConverter` å°†ä» SecurityContextHolder.getContext().getAuthentication() è·å– `Authentication`ï¼Œè‹¥ `Authentication` ä¸ä¸ºç©ºï¼Œæ‰§è¡Œ setAuthenticated(false) ï¼Œåœ¨ä¸€æ¬¡æ€§å¯†ç éªŒè¯æˆåŠŸåé‡æ–°ç½®ä¸ºtrueã€‚<br />
**2**: æ¥ä¸‹æ¥ `MfaAuthenticationToken` å°†ä¼ é€’ç»™ `AuthenticationManager` è¿›è¡ŒéªŒè¯ã€‚`ProviderManager`æ˜¯æœ€å¸¸ç”¨çš„`AuthenticationManager`å®ç°ç±»ã€‚ `ProviderManager`å°†éªŒè¯å§”æ‰˜ç»™ä¸€ä¸ª`AuthenticationProvider`Listå®ä¾‹ã€‚è¿™é‡Œæˆ‘ä»¬
ä½¿ç”¨`MfaAuthenticationProvider`æ‰§è¡Œä¸€æ¬¡æ€§å¯†ç éªŒè¯ã€‚<br />
**3**: å¦‚æœéªŒè¯å¤±è´¥ï¼Œåˆ™ä¸º*Failure*ã€‚`AuthenticationFailureHandler`è¢«è°ƒç”¨ï¼Œå“åº”JSONæ ¼å¼çš„é”™è¯¯ä¿¡æ¯ã€‚<br />
**4**: å¦‚æœéªŒè¯æˆåŠŸï¼Œåˆ™ä¸º*Success*ã€‚`AuthenticationSuccessHandler`è¢«è°ƒç”¨ï¼Œåœ¨`MfaAuthenticationTokenContextHolder`è®¾ç½®`MfaTokenContext`ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…å«ä¸€æ¬¡æ€§å¯†ç éªŒè¯æˆåŠŸä¿¡æ¯ã€‚

## ç”¨æˆ·æœåŠ¡

æˆ‘ä»¬å®ç°`UserDetails`æ¥å£åˆ›å»ºä¸€ä¸ª`MfaUserDetails`æ¨¡å‹å¢åŠ ä¸¤ä¸ªæ–°å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```java
public class MfaUserDetails implements UserDetails {
    ...

    private final boolean enableMfa;
    private String secret;

}

```
ç¬¬ä¸€ä¸ªæ˜¯æ ‡å¿—ï¼ŒæŒ‡ç¤ºæ˜¯å¦å¯ç”¨åŒå› ç´ èº«ä»½éªŒè¯ï¼Œç¬¬äºŒä¸ªæ˜¯ä¿å­˜å¯†é’¥çš„å­—ç¬¦ä¸²ã€‚



`InMemoryMfaUserDetailsManager`å®ç°` UserDetailsService`ä¸ºå­˜å‚¨åœ¨å†…å­˜ä¸­çš„åŸºäºç”¨æˆ·å/å¯†ç çš„èº«ä»½éªŒè¯æä¾›æ”¯æŒã€‚
`InMemoryMfaUserDetailsManager` é€šè¿‡å®ç° `UserDetailsManager` æ¥å£æä¾›å¯¹ `MfaUserDetails` çš„ç®¡ç†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class InMemoryMfaUserDetailsManager implements UserDetailsManager, UserDetailsPasswordService {
    private final Map<String, UserDetails> users = new HashMap<>();
    private AuthenticationManager authenticationManager;


    public InMemoryMfaUserDetailsManager() {
    }

    public InMemoryMfaUserDetailsManager(UserDetails... users) {
        UserDetails[] userDetails = users;
        int length = users.length;

        for (int i = 0; i < length; ++i) {
            UserDetails user = userDetails[i];
            this.createUser(user);
        }
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        MfaUserDetails user = (MfaUserDetails) this.users.get(username.toLowerCase());
        if (user == null) {
            throw new UsernameNotFoundException(username);
        } else {
            return new MfaUserDetails(user.getUsername(), user.getPassword(), user.isEnableMfa(), user.getSecret(), user.isEnabled(), user.isAccountNonExpired(), user.isCredentialsNonExpired(), user.isAccountNonLocked(), user.getAuthorities());
        }
    }

    @Override
    public void createUser(UserDetails user) {
        Assert.isTrue(!this.userExists(user.getUsername()), "user should not exist");
        this.users.put(user.getUsername().toLowerCase(), user);
    }

    @Override
    public void updateUser(UserDetails user) {
        Assert.isTrue(this.userExists(user.getUsername()), "user should exist");
        this.users.put(user.getUsername().toLowerCase(), user);
    }

    @Override
    public void deleteUser(String username) {
        this.users.remove(username.toLowerCase());
    }

    ...
}
```


## ç™»å½•æµç¨‹

æœ¬èŠ‚æˆ‘ä»¬å¯ç”¨ Spring Security çš„åŸºäºè¡¨å•çš„ç™»å½•ã€‚

```java
    @Bean
    SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests((authorize) -> authorize.anyRequest().authenticated())
                .formLogin();

        //...

        return http.build();
    }
```



æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ›´æ”¹è¡¨å•ç™»å½•çš„é»˜è®¤`AuthenticationSuccessHandler`å®ç°ç±»ï¼Œæˆ‘ä»¬åˆ›å»º`MfaAuthenticationSuccessHandler`å®ç°`AuthenticationSuccessHandler`ã€‚

```java
public class MfaAuthenticationSuccessHandler implements AuthenticationSuccessHandler {

    ...

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        UsernamePasswordAuthenticationToken authenticationToken = (UsernamePasswordAuthenticationToken) authentication;
        MfaUserDetails userDetails = (MfaUserDetails) authenticationToken.getPrincipal();
        if (userDetails.isEnableMfa()) {

            if (!StringUtils.hasText(userDetails.getSecret())) {
                String secret = mfaAuthenticationManager.generateSecret();
                userDetails.setSecret(secret);
                this.userDetailsManager.updateUser(userDetails);
                String uriForImage;
                try {
                    uriForImage = mfaAuthenticationManager.getUriForImage(userDetails.getUsername(), secret, "http://127.0.0.1:8080");
                } catch (Exception e) {
                    log.error("Error getting QR code image", e);
                    MfaAuthenticationResponse mfaAuthenticationResponse = MfaAuthenticationResponse.unauthenticated("Error getting QR code image", "bind", HttpStatus.BAD_REQUEST, null);
                    this.sendMfaResponse(request, response, mfaAuthenticationResponse);
                    return;
                }
                MfaAuthenticationResponse mfaAuthenticationResponse = MfaAuthenticationResponse.unauthenticated("The current account is not bound to the token app", "bind", HttpStatus.OK, uriForImage);
                this.sendMfaResponse(request, response, mfaAuthenticationResponse);
                return;
            }
            MfaTokenContext mfaTokenContext = MfaAuthenticationTokenContextHolder.getMfaTokenContext();
            if (mfaTokenContext == null || !mfaTokenContext.isMfa()) {
                MfaAuthenticationResponse mfaAuthenticationResponse = MfaAuthenticationResponse.unauthenticated("dynamic password error", "enable", HttpStatus.OK, null);
                this.sendMfaResponse(request, response, mfaAuthenticationResponse);
                return;
            }
        }

        Jwt jwt = this.tokenGenerator.generate(authentication);
        MfaAuthenticationResponse mfaAuthenticationResponse = MfaAuthenticationResponse.authenticated(userDetails.isEnableMfa() ? "enable" : "disabled", jwt.getTokenValue());
        this.sendMfaResponse(request, response, mfaAuthenticationResponse);
    }

    ...
}
```

æ­¤è¿‡ç¨‹ä¸­é‡è¦å‡ ä¸ªæ­¥éª¤ï¼š
1. ç”¨æˆ·æ˜¯å¦å¯ç”¨å¤šå› ç´ è®¤è¯ï¼Œè‹¥æœªå¯ç”¨åˆ™ç›´æ¥ç”ŸæˆJWTæ ¼å¼ä»¤ç‰Œã€‚
2. ç”¨æˆ·å·²ç»å¯ç”¨å¤šå› ç´ è®¤è¯ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç”Ÿæˆå¯†é’¥ï¼Œè‹¥æœªç”Ÿæˆå¯†é’¥ï¼Œåˆ™åˆ›å»º64ä½å¯†é’¥ï¼Œå¹¶å“åº” QR ç æä¾›ç»™ç”¨æˆ·è¿›è¡Œç»‘å®šã€‚
3. ä»`MfaAuthenticationTokenContextHolder`è·å–`MfaTokenContext`ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåˆ¤æ–­ä¸€æ¬¡æ€§å¯†ç æ˜¯å¦éªŒè¯é€šè¿‡ã€‚
4. ä¸€æ¬¡æ€§å¯†ç éªŒè¯é€šè¿‡ï¼Œæœ€ç»ˆç”ŸæˆJWTæ ¼å¼ä»¤ç‰Œã€‚

æœ€ç»ˆ Spring Security å®‰å…¨é…ç½®ä¸ºï¼š

```java
    @Bean
    SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests((authorize) -> authorize.anyRequest().authenticated())
                .formLogin().successHandler(MfaConfigurerUtils.getAuthenticationSuccessHandler(http));

                ...

        return http.build();
    }
```


## æ¼”ç¤º

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„æœ€ç»ˆå®ç°ç›®æ ‡ï¼Œå‰ç«¯å·¥ç¨‹ä½¿ç”¨ Vue å®ç°ï¼Œæ‚¨[å¯ä»¥ä»è¿™é‡Œ](https://github.com/ReLive27/spring-security-mfa-vue-template)æ‰¾åˆ°å®Œæ•´çš„å‰ç«¯æºä»£ç ã€‚

![](../static/images/blogs/mfa-demo.gif)

## ç»“è®º

å¤šå› ç´ èº«ä»½éªŒè¯é€šè¿‡æ·»åŠ é¢å¤–çš„å®‰å…¨å±‚æ¥æé«˜å®‰å…¨çº§åˆ«ï¼Œä»è€Œå¢åŠ ä¿¡ä»»å¹¶ä½¿æ”»å‡»è€…æ›´éš¾è®¿é—®æ‚¨çš„æ•°æ®ã€‚

ä¸å¾€å¸¸ä¸€æ ·ï¼Œæœ¬æ–‡ä¸­ä½¿ç”¨çš„æºä»£ç å¯[åœ¨ GitHub ä¸Š](https://github.com/ReLive27/spring-security-sample/tree/master/mfa-login)è·å¾—ã€‚
